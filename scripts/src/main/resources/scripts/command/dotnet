#!/usr/bin/env bash
# shellcheck source=scripts/functions
source "$(dirname "${0}")"/../functions
cd "${DEVON_IDE_HOME}" || exit 255


function doSetup() {    
  local dotnetCommand=$(dotnet --version)
  local software_version="3.0.100"

  if [ "$dotnetCommand" != "$software_version" ]
  then    
    if doIsMacOs
    then
      local fileSetup="dotnet-sdk-3.0.100-osx-x64.pkg"    
      local download_url="https://download.visualstudio.microsoft.com/download/pr/5c281f95-91c4-499d-baa2-31fec919047a/38c6964d72438ac30032bce516b655d9/dotnet-sdk-3.0.100-osx-x64.pkg"
    elif doIsWindows
    then
      fileSetup="dotnet-sdk-3.0.100-win-x64.exe"
      download_url="https://download.visualstudio.microsoft.com/download/pr/53f250a1-318f-4350-8bda-3c6e49f40e76/e8cbbd98b08edd6222125268166cfc43/dotnet-sdk-3.0.100-win-x64.exe"
    else
        DISTRO=$( cat /etc/*-release | tr [:upper:] [:lower:] | grep -Poi '(debian|ubuntu|red hat|centos|suse)' | uniq )
        if [ -z $DISTRO ]; then
            DISTRO='unknown'
        fi

        if [DISTRO=='red hat']
        then
          DISTRO='redhat'
        fi

        case "$DISTRO" in
          debian*)            wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.asc.gpg;
                              sudo mv microsoft.asc.gpg /etc/apt/trusted.gpg.d/;
                              wget -q https://packages.microsoft.com/config/debian/10/prod.list;
                              sudo mv prod.list /etc/apt/sources.list.d/microsoft-prod.list;
                              sudo chown root:root /etc/apt/trusted.gpg.d/microsoft.asc.gpg;
                              sudo chown root:root /etc/apt/sources.list.d/microsoft-prod.list;;                                

          ubuntu*)            wget -q https://packages.microsoft.com/config/ubuntu/19.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb ;
                              sudo dpkg -i packages-microsoft-prod.deb;; 

          redhat*)            sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc;
                              sudo wget -q -O /etc/yum.repos.d/microsoft-prod.repo https://packages.microsoft.com/config/fedora/30/prod.repo;;

          centos*)            sudo rpm -Uvh https://packages.microsoft.com/config/centos/7/packages-microsoft-prod.rpm ;;

          suse*)              sudo zypper install libicu;
                              sudo rpm --import https://packages.microsoft.com/keys/microsoft.asc;
                              wget -q https://packages.microsoft.com/config/opensuse/42.3/prod.repo;
                              sudo mv prod.repo /etc/zypp/repos.d/microsoft-prod.repo;
                              sudo chown root:root /etc/zypp/repos.d/microsoft-prod.repo;; 

          *)                  echo "unknown: $OSTYPE.  Not supported platform" ;
                              exit;;
        esac        
    fi

    if doIsMacOs || doIsWindows
    then
      doDownload "${download_url}"
      doRunCommand "~/Downloads/${fileSetup}"
    fi

    if [ -n "$dotnetCommand" ]
    then
      doEcho "Installing the devon4net API Template"
      doRunCommand "dotnet new -i devon4net.WebApi.Template"
      doEcho "devon4net API Template installed"
    fi
  fi
}

function doRun() {
  doSetup
  doEcho "Running: dotnet ${*}"
  if doIsQuiet
  then
    dotnet "${@}" > /dev/null
  else
    dotnet "${@}"
  fi
}

#CLI
case ${1} in 
"help" | "-h")
  echo "Setup or run dotnet."
  echo
  echo "Arguments:"
  echo " setup                    setup dotnet (install and verify)"
  echo " create «name» [«args»]   create a new devon4net application"
  echo
  exit
;;
"setup" | "s")
  doSetup setup
;;
"create" | "c")
  shift
  doSetup setup
  dotnet new Devon4NetAPI
;;
*)
  doRun "${*}"
;;
esac

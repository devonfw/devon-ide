#!/usr/bin/env bash
# shellcheck source=scripts/functions
source "$(dirname "${0}")"/../functions

function doSetup() {
  # We need a JDK
  doDevonCommand java -q setup
  # We need Maven for installing plug-ins
  doDevonCommand mvn -q setup
  if [ -n "${1}" ] || [ ! -d "${COBIGEN_CLI_HOME}" ]
  then
    local software_version="LATEST"
    local download_url="https://repository.sonatype.org/service/local/artifact/maven/redirect?r=central-proxy&g=com.devonfw.cobigen&a=templates-devon4j&v=${software_version}"

    doDownload "${download_url}" "${software_name}.jar" "${COBIGEN_CLI_HOME}"

    # We need to extract all needed files
    doRunCommand "unzip -q '${COBIGEN_CLI_HOME}/${software_name}.jar' 'cobigen.bat' -d '${COBIGEN_CLI_HOME}'"
    doRunCommand "unzip -q '${COBIGEN_CLI_HOME}/${software_name}.jar' 'cg.bat' -d '${COBIGEN_CLI_HOME}'"
    doRunCommand "unzip -q '${COBIGEN_CLI_HOME}/${software_name}.jar' 'class-loader-agent.jar' -d '${COBIGEN_CLI_HOME}'"
    doRunCommand "unzip -q '${COBIGEN_CLI_HOME}/${software_name}.jar' 'cobigen' -d '${COBIGEN_CLI_HOME}'"
    doRunCommand "unzip -q '${COBIGEN_CLI_HOME}/${software_name}.jar' 'cg' -d '${COBIGEN_CLI_HOME}'"

    doExtendPath "${COBIGEN_CLI_HOME}"
    doEcho "To be fully functional please rerun 'devon' command to update your PATH properly."
  else
    doEcho "Software already installed at ${COBIGEN_CLI_HOME}"
    doEcho "To force install please run devon cobigen setup."
  fi 
}

# $@: optional CobiGen arguments
function doRunCLI() {
  local cobigen_cmd="cobigen"
  doEcho "Running: ${cobigen_cmd} ${*}"
  if doIsQuiet
  then
    "${cobigen_cmd}" "${*}"
    exit ${?}
  else
    "${cobigen_cmd}" "${*} --verbose"
    exit ${?}
  fi
}

# CLI
software_name="cobigen"
COBIGEN_CLI_HOME="${DEVON_IDE_HOME}/software/${software_name}-cli"
if [ "${1}" = "-h" ] || [ "${1}" = "help" ]
then
  echo "Setup CobiGen CLI."
  echo
  echo "Arguments:"
  echo "                          run default build"
  echo " setup                    setup CobiGen CLI (install, verify)"
  echo " «args»                   call CobiGen CLI with the specified arguments"
  echo
  echo "Options:"
elif [ -z "${1}" ]
then
  doSetup
elif [ "${1}" = "setup" ]
then
  doSetup setup
else
  doRunCLI "${@}"
fi

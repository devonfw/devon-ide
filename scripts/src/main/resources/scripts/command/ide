#!/bin/bash
cd `dirname $0`
cd ../..
source scripts/functions
DEVON_IDE_REPO_URL="https://repo.maven.apache.org/maven2/com/devonfw/tools/ide"

function doUpdateScripts() {
  doUpgradeMavenArtifact "${DEVON_IDE_HOME}" "${DEVON_IDE_REPO_URL}" "devon-ide-settings" "${target_version}" ".tar.gz" "${devon_ide_version}"
  if [ "${?}" = 0 ]
  then
    cp "${DEVON_IDE_HOME}/scripts/devon" ~/.devon/devon
    if doIsWindows
    then
      cp "${DEVON_IDE_HOME}/scripts/devon.bat" "${USERPROFILE}/scripts/devon.bat"
    fi
  fi
}

function doUpdateSettings() {
  if [ ! -d "${SETTINGS_PATH}" ]
  then
    if [ -n "${1}"]
    then
      SETTINGS_URL="${1}"
    fi    
    if [ -z "${SETTINGS_URL}" ]
    then
      echo "*** ATTENTION ***"
      echo "Missing your settings at ${SETTINGS_PATH} and no SETTINGS_URL is defined."
      echo "Further details can be found here:"
      echo "https://github.com/devonfw/devon-ide/wiki/settings"
      echo "Please contact the technical lead of your project to get the SETTINGS_URL for your project."
      echo "In case you just want to test devon-ide you may simply hit return to install default settings."
      echo
      read -p "Settings URL: " answer
      if [ -z "${answer}" ]
      then
        SETTINGS_URL="${DEVON_IDE_REPO_URL}/devon-ide-settings"
        doUpgradeMavenArtifact "${SETTINGS_PATH}" "${DEVON_IDE_REPO_URL}" "devon-ide-settings" "${target_version}" ".zip"
      else
        SETTINGS_URL="${answer}"
        doInstall "${SETTINGS_PATH}" "${SETTINGS_URL}"
      fi
    else
      doInstall "${SETTINGS_PATH}" "${SETTINGS_URL}"
    fi
    if [ ! -d "${SETTINGS_PATH}" ]
    then
      doFail "Installation of settings failed!"
    fi
    if [ ! -d "${SETTINGS_PATH}/.git" ]
    then
      cd "${SETTINGS_PATH}"
      git init
      git add .
      git commit -m "Initial settings downloaded from ${SETTINGS_URL}"
      cd -
    fi
  else
    doUpgradeMavenArtifact "${SETTINGS_PATH}" "${DEVON_IDE_REPO_URL}" "devon-ide-settings" "${target_version}" ".zip"
  fi
}

function doSetup() {
  doUpdateSettings ${@}
  if [ -z "${DEVON_IDE_TOOLS}" ]
  then
    doFail "Variable DEVON_IDE_TOOLS is undefined. Please check your configuration (devon.properties)."
  fi
  for tool in "${DEVON_IDE_TOOLS[@]}"
  do
    echo
    echo "*** Setting up ${tool} ***"
    doDevonCommand ${tool} setup
  done
  if doIsWindows
  then
    if [ -e "${DEVON_IDE_HOME}/console.bat" ]
    then
      echo -e "@echo off\r\npushd %~dp0\r\ncall devon.bat\r\npopd\r\ncmd\r\n" > "${DEVON_IDE_HOME}/console.bat"
    fi
  fi
}

function doUninstall() {
  echo "Uninstalling devon-ide..."
  mkdir -p "${DEVON_IDE_HOME}/updates"
  if [ -f ~/.bashrc ]
  then
    cat ~/.bashrc | grep -v '^alias devon="source ~/.devon/devon"$' | grep -v '^devon$' > "${DEVON_IDE_HOME}/updates/.bashrc" && mv "${DEVON_IDE_HOME}/updates/.bashrc" ~/.bashrc
  fi
  if [ -f ~/.zshrc ]
  then
    cat ~/.zshrc | grep -v '^alias devon="source ~/.devon/devon"$' | grep -v '^devon$' > "${DEVON_IDE_HOME}/updates/.zshrc" && mv "${DEVON_IDE_HOME}/updates/.zshrc" ~/.zshrc
  fi
  doRunCommand 'rm -rf ~/.devon'
  if doIsWindows
  then
    echo "To uninstall the windows explorer integrations we need to apply changes to the windows registry:"
    echo "${DEVON_IDE_HOME}/system/windows/devon-uninstall.reg"
    echo "Simply confirm the popup with Yes or otherwise review and merge the registry file manually."
    regedit.exe "${DEVON_IDE_HOME}/system/windows/devon-uninstall.reg"
    if [ -d "${USERPROFILE}/.devon" ]
    then
      doRunCommand 'rm -rf "${USERPROFILE}/.devon"'
    fi
    if [ -f "${USERPROFILE}/scripts/devon" ]
    then
      doRunCommand 'rm "${USERPROFILE}/scripts/devon"'
    fi
  fi
  echo "So sad that you did not like devon-ide. It has been uninstalled from your system."
  echo "You can now manually delete ${DEVON_IDE_HOME} to remove it completely."
  echo "Goodbye and have a nice day!"
}

target_version="LATEST"

# CLI
if [ "${1}" = "-h" ] || [ "${1}" = "help" ]
then
  echo "Setup and update devon-ide."
  echo
  echo "Arguments:"
  echo "setup                            setup devon-ide"
  echo "update                           check for updates and install if newer version is available"
  echo "update «package» [to «version»]  update (or downgrade) specified package (to specified version)"
  echo "                                 packages are e.g. 'scripts' or 'settings'"
  echo "uninstall                        uninstall devon-ide and remove all OS hooks (revert devon ide setup)"
  exit
elif [ "${1}" = "setup" ]
then
  shift
  doSetup ${@}
elif [ "${1}" = "uninstall" ]
then
  doUninstall
elif [ "${1}" = "update" ]
then
  if [ -z "${2}" ]
  then
    doUpdateScripts
    doUpdateSettings
  else
    if [ "${3}" = "to" ]
    then
      if [ -z "${4}" ]
      then
        doFail "Missing version argument!\ndevon ide update to «version»"
      fi
      target_version="${4}"
    elif [ -n "${3}" ]
    then
      doFail "Undefined update argument ${3}!"
    fi
    if [ "${2}" = "scripts" ]
    then
      doUpdateScripts
    elif [ "${2}" = "settings" ]
    then
      doUpdateSettings
    else
      doFail "Undefined package ${2}"
    fi
  fi
  exit
elif [ -z "${1}" ]
then
  doFail "Unknown argument: ${1}"
else
  doFail "Missing arguments. Call 'devon help ide' to get help."
fi
echo
echo "Completed $@"
